<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PaperPrint - Catalogo Prodotti</title>
  <style>
    :root{--bg:#f3f6fb;--card:#fff;--text:#111827;--muted:#6b7280;--blue:#1e73ff;--red:#dc2626}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);
      background:linear-gradient(#f7f9ff,var(--bg))}
    .topbar{background:var(--card);box-shadow:0 1px 0 rgba(16,24,40,.06)}
    .topbar-inner{max-width:1320px;margin:0 auto;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;gap:16px}
    .brand{display:flex;align-items:center;gap:12px;font-weight:800;letter-spacing:.2px}
    .brand img{width:44px;height:44px;border-radius:12px;object-fit:contain;background:#fff}
    .brand span{font-size:28px;color:#0b5cff}
    .actions{display:flex;gap:12px}
    .searchbar{display:flex;align-items:center;gap:10px;background:#fff;border:1px solid rgba(16,24,40,.10);border-radius:14px;padding:8px 10px;box-shadow:0 10px 18px rgba(16,24,40,.06)}
    .searchbar input{border:0;outline:none;min-width:320px;max-width:520px;width:34vw;font-weight:700;font-size:14px;color:var(--text)}
    .searchbar input::placeholder{color:var(--muted);font-weight:700}
    .btn-secondary{border:1px solid rgba(16,24,40,.10);background:#fff;color:var(--blue);box-shadow:none}
    @media (max-width:900px){
      .actions{flex-wrap:wrap;justify-content:flex-end}
      .searchbar{width:100%}
      .searchbar input{min-width:0;width:100%}
    }
    .btn{border:0;background:var(--blue);color:#fff;padding:10px 18px;border-radius:12px;font-weight:700;cursor:pointer;
      box-shadow:0 10px 18px rgba(30,115,255,.18)}
    .btn:active{transform:translateY(1px)}
    .container{max-width:1320px;margin:0 auto;padding:40px 20px 26px}
    .title{display:flex;align-items:center;justify-content:center;gap:14px;margin:38px 0 10px}
    .title svg{width:52px;height:52px;flex:0 0 auto;filter:drop-shadow(0 8px 10px rgba(16,24,40,.08))}
    h1{text-align:center;font-size:54px;margin:0;letter-spacing:.2px}
    .subtitle{text-align:center;color:var(--muted);font-weight:700;margin:0 0 18px}

    .cats-wrap{margin:0 auto;display:flex;justify-content:center}
    .cats-grid{
      width:100%;
      max-width:1240px;
      display:grid;
      grid-template-columns:repeat(4,minmax(260px,1fr));
      gap:18px 34px;
      padding:28px 10px;
      align-items:stretch;
    }

    /* Tile: always 2 lines, no truncation */
    .cat-tile{
      display:flex;
      flex-direction:column;
      align-items:center;          /* center horizontally */
      justify-content:center;      /* center vertically */
      text-align:center;
      text-decoration:none;
      background: linear-gradient(#f7f9ff, var(--bg));
      border:0px solid rgba(16,24,40,.06);
      border-radius:14px;
      padding:14px 14px 12px;
      min-height:86px;             /* consistent "table cell" height */
      /*box-shadow:0 10px 18px rgba(16,24,40,.05);*/
    }
    .cat-tile:hover{border-color:rgba(30,115,255,.28); box-shadow:0 14px 26px rgba(16,24,40,.08)}
    .cat-name{
      color:var(--muted);
      font-size:16px;
      font-weight:800;
      line-height:1.15;
      white-space:normal;
      word-break:break-word;
      width:100%;
      display:flex;
      align-items:center;          /* vertical align within the name line area */
      justify-content:center;      /* center the icon+text block */
      gap:10px;
      min-height:34px;             /* forces consistent 2-line area */
    }

    .cat-icon{width:60px;height:60px;border-radius:8px;object-fit:cover;flex:0 0 40px;border:0px solid rgba(16,24,40,.06);background:#ffffff00}
    .cat-count{
      margin-top:6px;
      color:var(--red);
      font-size:15px;
      font-weight:900;
      line-height:1;
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .footer-report{text-align:center;margin-top:70px;font-size:12px;color:#111827;font-weight:700;padding:0 10px}
    .hint{text-align:center;color:var(--muted);margin-top:6px;font-size:13px;padding:0 10px}
    .warn{text-align:center;color:#b91c1c;font-weight:800;margin-top:10px}

    @media (max-width:1120px){
      h1{font-size:46px}
      .cats-grid{grid-template-columns:repeat(2,minmax(280px,1fr))}
    }
    @media (max-width:560px){
      h1{font-size:34px}
      .brand span{font-size:22px}
      .title svg{width:40px;height:40px}
      .cats-grid{grid-template-columns:1fr;max-width:520px}
      .cat-name{font-size:16px}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <img src="assets/logo.png" alt="PaperPrint" onerror="this.style.display='none'">
        <span>PaperPrint</span>
      </div>
      <div class="actions">
        <div class="searchbar" role="search" aria-label="Cerca articolo">
          <input id="articleSearch" type="search" placeholder="Cerca per SKU o descrizioneâ€¦">
          <button class="btn" id="btnSearch" type="button">Cerca Articolo</button>
        </div>
        <button class="btn btn-secondary" id="btnBack" type="button">Indietro</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="title">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path fill="#1e73ff" d="M10 4l2 2h8a2 2 0 0 1 2 2v10a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V6a2 2 0 0 1 2-2h6z"/>
        <path fill="#0b5cff" opacity=".25" d="M2 9h20v9a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V9z"/>
        <path fill="#ffffff" opacity=".9" d="M6.5 12.2h6.8a.8.8 0 1 1 0 1.6H6.5a.8.8 0 1 1 0-1.6zm0 3h11a.8.8 0 1 1 0 1.6h-11a.8.8 0 1 1 0-1.6z"/>
      </svg>
      <h1>Catalogo Prodotti</h1>
    </div>

    <div class="subtitle" id="subTitle">Categorie (conteggio dal feed)</div>

    <div class="cats-wrap">
      <div class="cats-grid" id="catsGrid"></div>
    </div>

    <div class="footer-report" id="reportLine">Ultimo Aggiornamento: in attesaâ€¦</div>
    <div class="warn" id="warnLine" style="display:none;"></div>
  </main>

  <script>
  // ====== Config ======
  const FEED_JSON_PATH = "output/feed_prodotti.json";
  const FEED_CSV_PATH  = "output/feed_prodotti.csv";
  const STATUS_JSON_PATH = "output/feed_status.json"; // opzionale
  const LIMIT_TO_TOP_N = 16;

  // ====== DOM ======
  const grid = document.getElementById('catsGrid');
  const report = document.getElementById('reportLine');
  const searchInput = document.getElementById('articleSearch');
  const searchBtn = document.getElementById('btnSearch');

  // ====== Utils ======
  function slugify(str) {
    return String(str || '')
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/(^-|-$)/g, '');
  }

  function formatInt(n) {
    try { return new Intl.NumberFormat('it-IT').format(Number(n) || 0); }
    catch { return String(Number(n) || 0); }
  }

  function parseGeneratedAtAsUtc(generatedAtStr) {
    if (!generatedAtStr) return null;
    const s = String(generatedAtStr).trim();

    // "YYYY-MM-DD HH:MM:SS" -> lo interpretiamo come UTC
    if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(s)) {
      return new Date(s.replace(' ', 'T') + 'Z');
    }

    // fallback: prova parsing nativo (eventuale ISO)
    const d = new Date(s);
    return isNaN(d.getTime()) ? null : d;
  }

  function formatLastUpdateRome(generatedAtStr) {
    const d = parseGeneratedAtAsUtc(generatedAtStr);
    if (!d) return '';

    const weekday = new Intl.DateTimeFormat('it-IT', { weekday: 'long', timeZone: 'Europe/Rome' }).format(d);
    const datePart = new Intl.DateTimeFormat('it-IT', { day: '2-digit', month: 'long', year: 'numeric', timeZone: 'Europe/Rome' }).format(d);
    const timePart = new Intl.DateTimeFormat('it-IT', { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'Europe/Rome' }).format(d);

    const W = weekday.charAt(0).toUpperCase() + weekday.slice(1);
    return `Ultimo aggiornamento ${W} ${datePart} - ore: ${timePart}`;
  }

  function escapeHtml(s) {
    return String(s ?? '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function parseCSV(text) {
    // parser semplice ma robusto (gestisce virgolette e separatore ; o ,)
    const lines = text.split(/\r?\n/).filter(Boolean);
    if (!lines.length) return [];

    // rileva separatore sulla header
    const headerLine = lines[0];
    const sep = (headerLine.match(/;/g)?.length || 0) >= (headerLine.match(/,/g)?.length || 0) ? ';' : ',';

    const rows = [];
    const headers = splitCSVLine(headerLine, sep).map(h => h.trim());
    for (let i = 1; i < lines.length; i++) {
      const cols = splitCSVLine(lines[i], sep);
      if (!cols.length) continue;
      const row = {};
      for (let c = 0; c < headers.length; c++) {
        const k = headers[c] || `col_${c}`;
        row[k] = (cols[c] ?? '').trim();
      }
      rows.push(row);
    }
    return rows;
  }

  function splitCSVLine(line, sep) {
    const out = [];
    let cur = '';
    let inQ = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') {
        // doppie virgolette dentro quote
        if (inQ && line[i + 1] === '"') { cur += '"'; i++; }
        else { inQ = !inQ; }
      } else if (ch === sep && !inQ) {
        out.push(cur);
        cur = '';
      } else {
        cur += ch;
      }
    }
    out.push(cur);
    return out;
  }

  // ====== Data loading ======
  async function loadCategoriesFromFeed() {
    // ritorna: { counts: Map<string, number>, total: number, source: 'json'|'csv' }
    // 1) Provo JSON
    try {
      const res = await fetch(FEED_JSON_PATH, { cache: 'no-store' });
      if (res.ok) {
        const data = await res.json();
        const items = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);
        if (items.length) {
          const counts = new Map();
          let total = 0;
          for (const it of items) {
            const cat = (it.MacroCategoria ?? it.Macrocat ?? it.Categoria ?? '').toString().trim();
            if (!cat) continue;
            counts.set(cat, (counts.get(cat) || 0) + 1);
            total++;
          }
          return { counts, total, source: 'json' };
        }
      }
    } catch (e) {
      // ignore, fallback to csv
      console.warn('JSON load failed, fallback to CSV', e);
    }

    // 2) Fallback CSV
    const res2 = await fetch(FEED_CSV_PATH, { cache: 'no-store' });
    if (!res2.ok) throw new Error('Impossibile caricare feed CSV');
    const text = await res2.text();
    const rows = parseCSV(text);

    const counts = new Map();
    let total = 0;
    for (const r of rows) {
      const cat = (r.MacroCategoria || r.Macrocat || r.Categoria || '').toString().trim();
      if (!cat) continue;
      counts.set(cat, (counts.get(cat) || 0) + 1);
      total++;
    }
    return { counts, total, source: 'csv' };
  }

  async function loadItemsFromFeed(){
    // returns array of raw items
    // 1) JSON
    try{
      const r = await fetch(FEED_JSON_PATH, { cache: 'no-store' });
      if (r.ok){
        const j = await r.json();
        const items = Array.isArray(j) ? j : (Array.isArray(j.items) ? j.items : []);
        if (items.length) return items;
      }
    }catch(e){
      // ignore and fallback
    }

    // 2) CSV fallback
    const r2 = await fetch(FEED_CSV_PATH, { cache: 'no-store' });
    if (!r2.ok) throw new Error('Impossibile caricare feed JSON/CSV');
    const txt = await r2.text();
    return parseCSV(txt);
  }

  function norm(s){
    return String(s || '').toLowerCase().trim();
  }

  function bestMatch(items, q){
    const query = norm(q);
    if (!query) return null;

    let best = null;
    let bestScore = -1;

    for (const it of (items || [])){
      const code = norm(it.ItemCode || it.SKU || it.sku || it.Code || it.code);
      const desc = norm(it.Descrizione || it.Description || it.name || it.Nome);
      const long = norm(it.DescrizioneLunga || it.LongDescription || it.long_description);
      const cat = String(it.MacroCategoria || it.Macrocat || it.Categoria || it.Category || '').trim();
      if (!cat) continue;

      let score = -1;
      if (code && code === query) score = 100;
      else if (code && code.includes(query)) score = 80;
      else if (desc && desc.includes(query)) score = 60;
      else if (long && long.includes(query)) score = 40;

      if (score > bestScore){
        bestScore = score;
        best = { item: it, cat };
        if (score === 100) break; // exact SKU
      }
    }

    return best;
  }

  function showSearchToast(text, ms=2000){
    let t = document.getElementById('ppSearchToast');
    if (!t){
      t = document.createElement('div');
      t.id = 'ppSearchToast';
      t.style.position = 'fixed';
      t.style.left = '50%';
      t.style.top = '92px';
      t.style.transform = 'translateX(-50%)';
      t.style.background = 'rgba(15,23,42,.92)';
      t.style.color = '#fff';
      t.style.padding = '12px 14px';
      t.style.borderRadius = '14px';
      t.style.boxShadow = '0 18px 50px rgba(0,0,0,.28)';
      t.style.zIndex = '9999';
      t.style.fontWeight = '800';
      t.style.fontSize = '14px';
      t.style.opacity = '0';
      t.style.pointerEvents = 'none';
      t.style.transition = 'opacity .16s ease';
      document.body.appendChild(t);
    }
    t.textContent = text;
    t.style.opacity = '1';
    clearTimeout(window.__ppSearchToastT);
    window.__ppSearchToastT = setTimeout(()=>{ t.style.opacity = '0'; }, ms);
  }

  async function handleArticleSearch(){
    const q = (searchInput?.value || '').trim();
    if (!q) return;

    try{
      searchBtn.disabled = true;
      const items = await loadItemsFromFeed();
      const hit = bestMatch(items, q);
      if (!hit){
        showSearchToast('ðŸ™‚ Nessun articolo trovato', 2000);
        return;
      }

      const cat = hit.cat;
      showSearchToast(`ðŸ˜Š L'articolo che stai cercando Ã¨ nella sezione ${cat}`, 2000);
      setTimeout(()=>{
        window.location.href = `categoria.html?cat=${encodeURIComponent(cat)}&q=${encodeURIComponent(q)}`;
      }, 2000);
    }catch(e){
      console.error(e);
      showSearchToast('ðŸ™‚ Errore durante la ricerca', 2000);
    }finally{
      setTimeout(()=>{ searchBtn.disabled = false; }, 2100);
    }
  }

  async function loadFeedStatus() {
    // opzionale: se esiste output/feed_status.json
    try {
      const res = await fetch(STATUS_JSON_PATH, { cache: 'no-store' });
      if (!res.ok) return null;
      return await res.json();
    } catch {
      return null;
    }
  }

  // ====== Rendering ======
  function renderCategories(countsMap) {
    const cats = Array.from(countsMap.entries())
      .map(([name, count]) => ({ name, count }))
      .sort((a, b) => a.name.localeCompare(b.name, 'it', { sensitivity: 'base' }));

    const toShow = cats.slice(0, LIMIT_TO_TOP_N);

    grid.innerHTML = toShow.map(c => {
      const safeName = escapeHtml(c.name);
      const safeCount = formatInt(c.count);
      // link unico: categoria.html?cat=<NomeCategoria>
      const url = `categoria.html?cat=${encodeURIComponent(c.name)}`;
      const slug = slugify(c.name) || 'default';
      const iconPath = `img/category-icons/${slug}.svg`;
      // include data attributes so we can resolve multiple file name candidates via JS
      return `
        <a class="cat-tile" href="${url}" title="Apri ${safeName}">
          <div class="cat-name"><img class="cat-icon" src="${iconPath}" alt="" data-slug="${slug}" data-name="${escapeHtml(c.name)}">${safeName}</div>
          <div class="cat-count">(${safeCount} Articoli)</div>
        </a>
      `;
    }).join('');

    // try to resolve icons for tiles: prefer category-icons/<slug>.svg then fallbacks in img/
    setTimeout(resolveCategoryIcons, 0);
  }

  function setReportLine(text) {
    report.textContent = text;
  }

  // ====== Init ======
  (async function init() {
    try {
      setReportLine('Carico categorie dal feed...');
      const { counts, total, source } = await loadCategoriesFromFeed();
      renderCategories(counts);

      const status = await loadFeedStatus();

      // Sottotitolo "Categorie 16 - 12.258 Articoli"
      const subTitleEl = document.getElementById('subTitle');
      const catCount = counts.size;
      const itemsCount = (status && status.count != null) ? Number(status.count) : Number(total);
      if (subTitleEl) {
        subTitleEl.textContent = `Categorie ${formatInt(catCount)} - ${formatInt(itemsCount)} Articoli`;
      }

      // Riga in basso: formato umano + fuso Europe/Rome (niente debug)
      if (status && status.generated_at) {
        const pretty = formatLastUpdateRome(status.generated_at);
        setReportLine(pretty || 'Ultimo aggiornamento: in attesaâ€¦');
      } else {
        setReportLine('Ultimo aggiornamento: in attesaâ€¦');
      }
    } catch (e) {
      console.error(e);
      setReportLine('Errore: non riesco a leggere il feed. Controlla che output/feed_prodotti.json o output/feed_prodotti.csv esista.');
      grid.innerHTML = '';
    }
  })();
  
  // Try multiple candidate paths for category icons and pick the first that loads.
  function resolveCategoryIcons(){
    const imgs = Array.from(document.querySelectorAll('.cat-icon'));
    if (!imgs.length) return;
    for (const img of imgs){
      const slug = img.dataset.slug || '';
      const name = img.dataset.name || '';
      const candidates = [];
      // prefer category-icons svg/png
//      if (slug) candidates.push(`img/category-icons/${slug}.svg`);
      if (slug) candidates.push(`img/category-icons/${slug}.png`);
      // try flat img folder variations
      if (name) candidates.push(`img/${encodeURIComponent(name)}.png`);
      if (slug) candidates.push(`img/${slug}.png`);
      // fallback to default
      candidates.push('img/category-icons/default.png');

      (function tryNext(i){
        if (i >= candidates.length) return;
        const url = candidates[i];
        const tester = new Image();
        tester.onload = function(){ img.src = url; };
        tester.onerror = function(){ tryNext(i+1); };
        tester.src = url;
      })(0);
    }
  }

  // Back button: ensure it always returns to admin dashboard
  (function(){
    try{
      const b = document.getElementById('btnBack');
      if (b){ b.addEventListener('click', ()=>{ window.location.href = 'admin.html'; }); }
    }catch(e){ console.warn('btnBack wiring failed', e); }
  })();

  // Article search wiring
  (function(){
    if (searchBtn) searchBtn.addEventListener('click', handleArticleSearch);
    if (searchInput) searchInput.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter') handleArticleSearch();
    });
  })();
</script>
</body>
</html>
